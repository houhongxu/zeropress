<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZEROPRESS</title>
  <link rel="stylesheet" href="/assets/client-entry-UI1mcJZ-.css">
  <body>
    <div id="root"><header class="pc:fixed absolute left-0 top-0 z-50 w-full"><div class="border-divider bg-bg-default h-nav border-b px-[12px] pt-px transition-colors duration-300"><div class="flex h-full items-center justify-between"><div class="flex h-full justify-start"><div class="h-full"><nav class="mx-[12px] flex h-full items-center"><a class="cursor-pointer"><img src="/logo.jpg" class="h-[24px] w-[24px]"/></a></nav></div></div><div class="flex h-full justify-end"><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">笔记</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">测试</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-brand text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">离谱</a></nav></div><div class="h-full"><nav class="mx-[4px] flex h-full items-center"><button class="bg-bg-switch border-divider hover:border-gray-1 relative h-[22px] w-[40px] rounded-[11px] border transition-colors duration-300"><div class="bg-bg-inverse shadow-1 absolute left-px top-px h-[18px] w-[18px] overflow-hidden rounded-[50%] transition-all duration-300 dark:translate-x-[18px]"><span class="*:text-text-2 *:absolute *:left-[3px] *:top-[3px] *:h-[12px] *:w-[12px] *:transition-opacity *:duration-300"><div class="icon-[carbon--sun] opacity-100 dark:opacity-0"></div><div class="icon-[carbon--moon] opacity-0 dark:opacity-100"></div></span></div></button></nav></div><div class="h-full"><nav class="mx-[12px] h-full"><a href="https://github.com/houhongxu/hhxpress" class="cursor-pointer text-text-2 text-hover flex  h-full items-center"><span class="icon-[carbon--logo-github] h-[24px] w-[24px]"></span></a></nav></div></div></div></div></header><div class="pt-nav"><aside class="mt-nav w-sidebar border-divider bg-bg-sidebar pc:-translate-x-0 fixed inset-y-0 left-0 z-40 -translate-x-full overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>ahooks</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:270px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useLocalStorageState与useSessionStorageState</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useUpdateEffect 与 useUpdateLayoutEffectt</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useLatest与useMemoizedFn</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">use(Raf)Timeout与use(Raf)Interval与useCountDown</a><a class="cursor-pointer text-brand text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useRequest</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useMount与useUnMount与useMountedRefx.md</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useUpdate</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useCreation</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useDeepCompareEffect</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useAnimationFrame和计时器</a></div></div></aside><div class="pc:ml-sidebar ml-0 flex justify-between"><div class="mx-auto w-full max-w-[768px] transition-[margin] duration-300"><div class="h-nav pc:hidden bg-bg-default sticky top-0 z-50 w-full border-b"><div class="flex h-full items-center justify-between px-[24px]"><a class="icon-[carbon--list] h-[24px] w-[24px] cursor-pointer"></a><a class="icon-[carbon--border-top] h-[24px] w-[24px] cursor-pointer"></a></div><div class="fixed inset-0 bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-sidebar border-divider bg-bg-sidebar fixed inset-y-0 left-0 z-40 overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300 -translate-x-full"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>ahooks</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:270px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useLocalStorageState与useSessionStorageState</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useUpdateEffect 与 useUpdateLayoutEffectt</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useLatest与useMemoizedFn</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">use(Raf)Timeout与use(Raf)Interval与useCountDown</a><a class="cursor-pointer text-brand text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useRequest</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useMount与useUnMount与useMountedRefx.md</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useUpdate</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useCreation</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useDeepCompareEffect</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">useAnimationFrame和计时器</a></div></div></aside><div class="fixed inset-0  bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-toc border-divider bg-bg-sidebar fixed inset-y-0 right-0 z-40  h-full border-l px-[28px] py-[16px] transition-transform duration-300 translate-x-full"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#userequestimplement" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">useRequestImplement</a></div><div><a href="#fetch" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">Fetch</a></div></div></div></aside></div><div class="p-[48px]"><div class="doc"><h1 id="userequest"><a class="autolink-headings" href="#userequest"><span style="margin-right:4px">#</span></a>useRequest</h1>
<p>useRequest 使用的插件机制
通过 useRequestImplement 引入插件</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="ts" data-theme="github-light"><code data-language="ts" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#6A737D">// function useRequest&lt;TData, TParams extends any[], TFormated, TTFormated extends TFormated = any&gt;(</span></span>
<span data-line=""><span style="color:#6A737D">//   service: Service&lt;TData, TParams&gt;,</span></span>
<span data-line=""><span style="color:#6A737D">//   options: OptionsWithFormat&lt;TData, TParams, TFormated, TTFormated&gt;,</span></span>
<span data-line=""><span style="color:#6A737D">//   plugins?: Plugin&lt;TData, TParams&gt;[],</span></span>
<span data-line=""><span style="color:#6A737D">// ): Result&lt;TFormated, TParams&gt;</span></span>
<span data-line=""><span style="color:#6A737D">// function useRequest&lt;TData, TParams extends any[]&gt;(</span></span>
<span data-line=""><span style="color:#6A737D">//   service: Service&lt;TData, TParams&gt;,</span></span>
<span data-line=""><span style="color:#6A737D">//   options?: OptionsWithoutFormat&lt;TData, TParams&gt;,</span></span>
<span data-line=""><span style="color:#6A737D">//   plugins?: Plugin&lt;TData, TParams&gt;[],</span></span>
<span data-line=""><span style="color:#6A737D">// ): Result&lt;TData, TParams&gt;</span></span>
<span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> useRequest</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#D73A49"> extends</span><span style="color:#005CC5"> any</span><span style="color:#24292E">[]&gt;(</span></span>
<span data-line=""><span style="color:#E36209">  service</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Service</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;, </span><span style="color:#6A737D">// service就是接口</span></span>
<span data-line=""><span style="color:#E36209">  options</span><span style="color:#D73A49">?:</span><span style="color:#6F42C1"> Options</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;, </span><span style="color:#6A737D">// options就是配置项</span></span>
<span data-line=""><span style="color:#E36209">  plugins</span><span style="color:#D73A49">?:</span><span style="color:#6F42C1"> Plugin</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;[], </span><span style="color:#6A737D">// plugins是插件</span></span>
<span data-line=""><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#6F42C1"> useRequestImplement</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;(service, options, [</span></span>
<span data-line=""><span style="color:#D73A49">    ...</span><span style="color:#24292E">(plugins </span><span style="color:#D73A49">||</span><span style="color:#24292E"> []),</span></span>
<span data-line=""><span style="color:#24292E">    useDebouncePlugin,</span></span>
<span data-line=""><span style="color:#24292E">    useLoadingDelayPlugin,</span></span>
<span data-line=""><span style="color:#24292E">    usePollingPlugin,</span></span>
<span data-line=""><span style="color:#24292E">    useRefreshOnWindowFocusPlugin,</span></span>
<span data-line=""><span style="color:#24292E">    useThrottlePlugin,</span></span>
<span data-line=""><span style="color:#24292E">    useAutoRunPlugin,</span></span>
<span data-line=""><span style="color:#24292E">    useCachePlugin,</span></span>
<span data-line=""><span style="color:#24292E">    useRetryPlugin,</span></span>
<span data-line=""><span style="color:#24292E">  ] </span><span style="color:#D73A49">as</span><span style="color:#6F42C1"> Plugin</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;[])</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="userequestimplement"><a class="autolink-headings" href="#userequestimplement"><span style="margin-right:4px">#</span></a>useRequestImplement</h2>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="ts" data-theme="github-light"><code data-language="ts" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> useRequestImplement</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#D73A49"> extends</span><span style="color:#005CC5"> any</span><span style="color:#24292E">[]&gt;(</span></span>
<span data-line=""><span style="color:#E36209">  service</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Service</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;, </span><span style="color:#6A737D">// service就是接口，useRequset透传</span></span>
<span data-line=""><span style="color:#E36209">  options</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Options</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt; </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {}, </span><span style="color:#6A737D">// options就是配置项，useRequset透传</span></span>
<span data-line=""><span style="color:#E36209">  plugins</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Plugin</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;[] </span><span style="color:#D73A49">=</span><span style="color:#24292E"> [], </span><span style="color:#6A737D">// plugins是插件，</span></span>
<span data-line=""><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">  const</span><span style="color:#24292E"> { </span><span style="color:#005CC5">manual</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> false</span><span style="color:#24292E">, </span><span style="color:#D73A49">...</span><span style="color:#005CC5">rest</span><span style="color:#24292E"> } </span><span style="color:#D73A49">=</span><span style="color:#24292E"> options</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 开发环境</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (isDev) {</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (options.defaultParams </span><span style="color:#D73A49">&amp;&amp;</span><span style="color:#D73A49"> !</span><span style="color:#24292E">Array.</span><span style="color:#6F42C1">isArray</span><span style="color:#24292E">(options.defaultParams)) {</span></span>
<span data-line=""><span style="color:#24292E">      console.</span><span style="color:#6F42C1">warn</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#032F62">        `expected defaultParams is array, got ${</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> options</span><span style="color:#032F62">.</span><span style="color:#24292E">defaultParams</span><span style="color:#032F62">}`</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 将配置了默认manual的配置项给fetch</span></span>
<span data-line=""><span style="color:#D73A49">  const</span><span style="color:#005CC5"> fetchOptions</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">    manual,</span></span>
<span data-line=""><span style="color:#D73A49">    ...</span><span style="color:#24292E">rest,</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 始终保存最新的请求函数</span></span>
<span data-line=""><span style="color:#D73A49">  const</span><span style="color:#005CC5"> serviceRef</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> useLatest</span><span style="color:#24292E">(service)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 强制组件重新渲染的函数</span></span>
<span data-line=""><span style="color:#D73A49">  const</span><span style="color:#005CC5"> update</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> useUpdate</span><span style="color:#24292E">()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // Fetch实例处理请求，useCreation确保实例不会重复创建</span></span>
<span data-line=""><span style="color:#D73A49">  const</span><span style="color:#005CC5"> fetchInstance</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> useCreation</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">    // 调用插件的初始化钩子，然后获取Fetch初始值，如useAutoRunPlugin配置了loading初始值，注意和其他钩子在插件中写法不一样，这个是直接挂在函数上的，而不是返回值上</span></span>
<span data-line=""><span style="color:#D73A49">    const</span><span style="color:#005CC5"> initState</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> plugins</span></span>
<span data-line=""><span style="color:#24292E">      .</span><span style="color:#6F42C1">map</span><span style="color:#24292E">((</span><span style="color:#E36209">p</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> p?.</span><span style="color:#6F42C1">onInit</span><span style="color:#24292E">?.(fetchOptions))</span></span>
<span data-line=""><span style="color:#24292E">      .</span><span style="color:#6F42C1">filter</span><span style="color:#24292E">(Boolean)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> Fetch</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;(</span></span>
<span data-line=""><span style="color:#24292E">      serviceRef,</span></span>
<span data-line=""><span style="color:#24292E">      fetchOptions,</span></span>
<span data-line=""><span style="color:#24292E">      update,</span></span>
<span data-line=""><span style="color:#24292E">      Object.</span><span style="color:#6F42C1">assign</span><span style="color:#24292E">({}, </span><span style="color:#D73A49">...</span><span style="color:#24292E">initState),</span></span>
<span data-line=""><span style="color:#24292E">    )</span></span>
<span data-line=""><span style="color:#24292E">  }, [])</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 在fetchInstance保存fetchOptions，为了fetchInstance调用options里的钩子，但是为什么类中没定义这个变量?</span></span>
<span data-line=""><span style="color:#24292E">  fetchInstance.options </span><span style="color:#D73A49">=</span><span style="color:#24292E"> fetchOptions</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 执行所有插件返回的包含多个钩子的对象</span></span>
<span data-line=""><span style="color:#24292E">  fetchInstance.pluginImpls </span><span style="color:#D73A49">=</span><span style="color:#24292E"> plugins.</span><span style="color:#6F42C1">map</span><span style="color:#24292E">((</span><span style="color:#E36209">p</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#6F42C1"> p</span><span style="color:#24292E">(fetchInstance, fetchOptions))</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 组件渲染时，未配置手动请求时，发起请求</span></span>
<span data-line=""><span style="color:#6F42C1">  useMount</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">manual) {</span></span>
<span data-line=""><span style="color:#6A737D">      // useCachePlugin can set fetchInstance.state.params from cache when init</span></span>
<span data-line=""><span style="color:#D73A49">      const</span><span style="color:#005CC5"> params</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> fetchInstance.state.params </span><span style="color:#D73A49">||</span><span style="color:#24292E"> options.defaultParams </span><span style="color:#D73A49">||</span><span style="color:#24292E"> []</span></span>
<span data-line=""><span style="color:#6A737D">      // @ts-ignore</span></span>
<span data-line=""><span style="color:#24292E">      fetchInstance.</span><span style="color:#6F42C1">run</span><span style="color:#24292E">(</span><span style="color:#D73A49">...</span><span style="color:#24292E">params)</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 组件销毁时取消请求</span></span>
<span data-line=""><span style="color:#6F42C1">  useUnmount</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">    fetchInstance.</span><span style="color:#6F42C1">cancel</span><span style="color:#24292E">()</span></span>
<span data-line=""><span style="color:#24292E">  })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">    loading: fetchInstance.state.loading,</span></span>
<span data-line=""><span style="color:#24292E">    data: fetchInstance.state.data,</span></span>
<span data-line=""><span style="color:#24292E">    error: fetchInstance.state.error,</span></span>
<span data-line=""><span style="color:#24292E">    params: fetchInstance.state.params </span><span style="color:#D73A49">||</span><span style="color:#24292E"> [],</span></span>
<span data-line=""><span style="color:#24292E">    cancel: </span><span style="color:#6F42C1">useMemoizedFn</span><span style="color:#24292E">(fetchInstance.cancel.</span><span style="color:#6F42C1">bind</span><span style="color:#24292E">(fetchInstance)),</span></span>
<span data-line=""><span style="color:#24292E">    refresh: </span><span style="color:#6F42C1">useMemoizedFn</span><span style="color:#24292E">(fetchInstance.refresh.</span><span style="color:#6F42C1">bind</span><span style="color:#24292E">(fetchInstance)),</span></span>
<span data-line=""><span style="color:#24292E">    refreshAsync: </span><span style="color:#6F42C1">useMemoizedFn</span><span style="color:#24292E">(fetchInstance.refreshAsync.</span><span style="color:#6F42C1">bind</span><span style="color:#24292E">(fetchInstance)),</span></span>
<span data-line=""><span style="color:#24292E">    run: </span><span style="color:#6F42C1">useMemoizedFn</span><span style="color:#24292E">(fetchInstance.run.</span><span style="color:#6F42C1">bind</span><span style="color:#24292E">(fetchInstance)),</span></span>
<span data-line=""><span style="color:#24292E">    runAsync: </span><span style="color:#6F42C1">useMemoizedFn</span><span style="color:#24292E">(fetchInstance.runAsync.</span><span style="color:#6F42C1">bind</span><span style="color:#24292E">(fetchInstance)),</span></span>
<span data-line=""><span style="color:#24292E">    mutate: </span><span style="color:#6F42C1">useMemoizedFn</span><span style="color:#24292E">(fetchInstance.mutate.</span><span style="color:#6F42C1">bind</span><span style="color:#24292E">(fetchInstance)),</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">as</span><span style="color:#6F42C1"> Result</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="fetch"><a class="autolink-headings" href="#fetch"><span style="margin-right:4px">#</span></a>Fetch</h2>
<p>核心代码</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="ts" data-theme="github-light"><code data-language="ts" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">export</span><span style="color:#D73A49"> default</span><span style="color:#D73A49"> class</span><span style="color:#6F42C1"> Fetch</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#D73A49"> extends</span><span style="color:#005CC5"> any</span><span style="color:#24292E">[]&gt; {</span></span>
<span data-line=""><span style="color:#6A737D">  // 插件钩子对象的数组</span></span>
<span data-line=""><span style="color:#E36209">  pluginImpls</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> PluginReturn</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;[]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 记录的请求次数</span></span>
<span data-line=""><span style="color:#E36209">  count</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> number</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> 0</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 状态</span></span>
<span data-line=""><span style="color:#E36209">  state</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> FetchState</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt; </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">    loading: </span><span style="color:#005CC5">false</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">    params: </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">    data: </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">    error: </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  constructor</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#D73A49">    public</span><span style="color:#E36209"> serviceRef</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> MutableRefObject</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">Service</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;&gt;, </span><span style="color:#6A737D">// service</span></span>
<span data-line=""><span style="color:#D73A49">    public</span><span style="color:#E36209"> options</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Options</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;, </span><span style="color:#6A737D">// options</span></span>
<span data-line=""><span style="color:#D73A49">    public</span><span style="color:#E36209"> subscribe</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Subscribe</span><span style="color:#24292E">, </span><span style="color:#6A737D">// 强制渲染的函数</span></span>
<span data-line=""><span style="color:#D73A49">    public</span><span style="color:#E36209"> initState</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Partial</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">FetchState</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;&gt; </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {}, </span><span style="color:#6A737D">// 初始状态</span></span>
<span data-line=""><span style="color:#24292E">  ) {</span></span>
<span data-line=""><span style="color:#6A737D">    // 设置初始状态</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.state </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#D73A49">      ...</span><span style="color:#005CC5">this</span><span style="color:#24292E">.state,</span></span>
<span data-line=""><span style="color:#24292E">      loading: </span><span style="color:#D73A49">!</span><span style="color:#24292E">options.manual,</span></span>
<span data-line=""><span style="color:#D73A49">      ...</span><span style="color:#24292E">initState,</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 设置状态并强制渲染，没有用react的useState来保证状态改变时渲染，而是用强制渲染新数据实现</span></span>
<span data-line=""><span style="color:#6F42C1">  setState</span><span style="color:#24292E">(</span><span style="color:#E36209">s</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Partial</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">FetchState</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;&gt; </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {}) {</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.state </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#D73A49">      ...</span><span style="color:#005CC5">this</span><span style="color:#24292E">.state,</span></span>
<span data-line=""><span style="color:#D73A49">      ...</span><span style="color:#24292E">s,</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">subscribe</span><span style="color:#24292E">()</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 执行钩子</span></span>
<span data-line=""><span style="color:#6F42C1">  runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#E36209">event</span><span style="color:#D73A49">:</span><span style="color:#D73A49"> keyof</span><span style="color:#6F42C1"> PluginReturn</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">, </span><span style="color:#6F42C1">TParams</span><span style="color:#24292E">&gt;, </span><span style="color:#D73A49">...</span><span style="color:#E36209">rest</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> any</span><span style="color:#24292E">[]) {</span></span>
<span data-line=""><span style="color:#6A737D">    // 遍历插件钩子对象的数组，执行对应钩子</span></span>
<span data-line=""><span style="color:#D73A49">    const</span><span style="color:#005CC5"> r</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.pluginImpls.</span><span style="color:#6F42C1">map</span><span style="color:#24292E">((</span><span style="color:#E36209">i</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> i[event]?.(</span><span style="color:#D73A49">...</span><span style="color:#24292E">rest)).</span><span style="color:#6F42C1">filter</span><span style="color:#24292E">(Boolean)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 返回钩子给的状态</span></span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#24292E"> Object.</span><span style="color:#6F42C1">assign</span><span style="color:#24292E">({}, </span><span style="color:#D73A49">...</span><span style="color:#24292E">r)</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 核心请求函数</span></span>
<span data-line=""><span style="color:#D73A49">  async</span><span style="color:#6F42C1"> runAsync</span><span style="color:#24292E">(</span><span style="color:#D73A49">...</span><span style="color:#E36209">params</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> TParams</span><span style="color:#24292E">)</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> Promise</span><span style="color:#24292E">&lt;</span><span style="color:#6F42C1">TData</span><span style="color:#24292E">&gt; {</span></span>
<span data-line=""><span style="color:#6A737D">    // 请求次数加一</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.count </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 1</span></span>
<span data-line=""><span style="color:#D73A49">    const</span><span style="color:#005CC5"> currentCount</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.count</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 执行插件onBefore钩子，并获取钩子给的状态</span></span>
<span data-line=""><span style="color:#D73A49">    const</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#005CC5">      stopNow</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> false</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#005CC5">      returnNow</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> false</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#D73A49">      ...</span><span style="color:#005CC5">state</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;onBefore&#x27;</span><span style="color:#24292E">, params)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 如果钩子给了stopNow就停止</span></span>
<span data-line=""><span style="color:#6A737D">    // stop request</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (stopNow) {</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#D73A49"> new</span><span style="color:#005CC5"> Promise</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {})</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 强制渲染新状态</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">setState</span><span style="color:#24292E">({</span></span>
<span data-line=""><span style="color:#24292E">      loading: </span><span style="color:#005CC5">true</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">      params,</span></span>
<span data-line=""><span style="color:#D73A49">      ...</span><span style="color:#24292E">state,</span></span>
<span data-line=""><span style="color:#24292E">    })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 如果钩子给了stopNow就返回</span></span>
<span data-line=""><span style="color:#6A737D">    // return now</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (returnNow) {</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#005CC5"> Promise</span><span style="color:#24292E">.</span><span style="color:#6F42C1">resolve</span><span style="color:#24292E">(state.data)</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 调用配置里的钩子onBefore</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.options.</span><span style="color:#6F42C1">onBefore</span><span style="color:#24292E">?.(params)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    try</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">      // 获取真正的请求函数</span></span>
<span data-line=""><span style="color:#D73A49">      let</span><span style="color:#24292E"> { servicePromise } </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#032F62">        &#x27;onRequest&#x27;</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#005CC5">        this</span><span style="color:#24292E">.serviceRef.current,</span></span>
<span data-line=""><span style="color:#24292E">        params,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">servicePromise) {</span></span>
<span data-line=""><span style="color:#24292E">        servicePromise </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.serviceRef.</span><span style="color:#6F42C1">current</span><span style="color:#24292E">(</span><span style="color:#D73A49">...</span><span style="color:#24292E">params)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 开始请求，res是promise的then</span></span>
<span data-line=""><span style="color:#D73A49">      const</span><span style="color:#005CC5"> res</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> await</span><span style="color:#24292E"> servicePromise</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 取消请求</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (currentCount </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.count) {</span></span>
<span data-line=""><span style="color:#6A737D">        // prevent run.then when request is canceled</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#D73A49"> new</span><span style="color:#005CC5"> Promise</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {})</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // const formattedResult = this.options.formatResultRef.current ? this.options.formatResultRef.current(res) : res;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 强制渲染新状态</span></span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">setState</span><span style="color:#24292E">({</span></span>
<span data-line=""><span style="color:#24292E">        data: res,</span></span>
<span data-line=""><span style="color:#24292E">        error: </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">        loading: </span><span style="color:#005CC5">false</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">      })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 调用配置里的钩子onSuccess和插件里的</span></span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.options.</span><span style="color:#6F42C1">onSuccess</span><span style="color:#24292E">?.(res, params)</span></span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;onSuccess&#x27;</span><span style="color:#24292E">, res, params)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 调用配置里的钩子onFinally</span></span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.options.</span><span style="color:#6F42C1">onFinally</span><span style="color:#24292E">?.(params, res, </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 调用插件里的钩子onFinally</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (currentCount </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.count) {</span></span>
<span data-line=""><span style="color:#005CC5">        this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;onFinally&#x27;</span><span style="color:#24292E">, params, res, </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 返回promise的then</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> res</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">catch</span><span style="color:#24292E"> (error) {</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (currentCount </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.count) {</span></span>
<span data-line=""><span style="color:#6A737D">        // prevent run.then when request is canceled</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#D73A49"> new</span><span style="color:#005CC5"> Promise</span><span style="color:#24292E">(() </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {})</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">setState</span><span style="color:#24292E">({</span></span>
<span data-line=""><span style="color:#24292E">        error,</span></span>
<span data-line=""><span style="color:#24292E">        loading: </span><span style="color:#005CC5">false</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">      })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.options.</span><span style="color:#6F42C1">onError</span><span style="color:#24292E">?.(error, params)</span></span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;onError&#x27;</span><span style="color:#24292E">, error, params)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">      this</span><span style="color:#24292E">.options.</span><span style="color:#6F42C1">onFinally</span><span style="color:#24292E">?.(params, </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">, error)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (currentCount </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.count) {</span></span>
<span data-line=""><span style="color:#005CC5">        this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;onFinally&#x27;</span><span style="color:#24292E">, params, </span><span style="color:#005CC5">undefined</span><span style="color:#24292E">, error)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      throw</span><span style="color:#24292E"> error</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 处理了promise的then的错误的函数</span></span>
<span data-line=""><span style="color:#6F42C1">  run</span><span style="color:#24292E">(</span><span style="color:#D73A49">...</span><span style="color:#E36209">params</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> TParams</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runAsync</span><span style="color:#24292E">(</span><span style="color:#D73A49">...</span><span style="color:#24292E">params).</span><span style="color:#6F42C1">catch</span><span style="color:#24292E">((</span><span style="color:#E36209">error</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#005CC5">this</span><span style="color:#24292E">.options.onError) {</span></span>
<span data-line=""><span style="color:#24292E">        console.</span><span style="color:#6F42C1">error</span><span style="color:#24292E">(error)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    })</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 取消请求</span></span>
<span data-line=""><span style="color:#6F42C1">  cancel</span><span style="color:#24292E">() {</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.count </span><span style="color:#D73A49">+=</span><span style="color:#005CC5"> 1</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">setState</span><span style="color:#24292E">({</span></span>
<span data-line=""><span style="color:#24292E">      loading: </span><span style="color:#005CC5">false</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">    })</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;onCancel&#x27;</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 再请求一次</span></span>
<span data-line=""><span style="color:#6F42C1">  refresh</span><span style="color:#24292E">() {</span></span>
<span data-line=""><span style="color:#6A737D">    // @ts-ignore</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">run</span><span style="color:#24292E">(</span><span style="color:#D73A49">...</span><span style="color:#24292E">(</span><span style="color:#005CC5">this</span><span style="color:#24292E">.state.params </span><span style="color:#D73A49">||</span><span style="color:#24292E"> []))</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 返回新请求的promise的then</span></span>
<span data-line=""><span style="color:#6F42C1">  refreshAsync</span><span style="color:#24292E">() {</span></span>
<span data-line=""><span style="color:#6A737D">    // @ts-ignore</span></span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#005CC5"> this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runAsync</span><span style="color:#24292E">(</span><span style="color:#D73A49">...</span><span style="color:#24292E">(</span><span style="color:#005CC5">this</span><span style="color:#24292E">.state.params </span><span style="color:#D73A49">||</span><span style="color:#24292E"> []))</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 修改data</span></span>
<span data-line=""><span style="color:#6F42C1">  mutate</span><span style="color:#24292E">(</span><span style="color:#E36209">data</span><span style="color:#D73A49">?:</span><span style="color:#6F42C1"> TData</span><span style="color:#D73A49"> |</span><span style="color:#24292E"> ((</span><span style="color:#E36209">oldData</span><span style="color:#D73A49">?:</span><span style="color:#6F42C1"> TData</span><span style="color:#24292E">) </span><span style="color:#D73A49">=&gt;</span><span style="color:#6F42C1"> TData</span><span style="color:#D73A49"> |</span><span style="color:#005CC5"> undefined</span><span style="color:#24292E">)) {</span></span>
<span data-line=""><span style="color:#D73A49">    const</span><span style="color:#005CC5"> targetData</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> isFunction</span><span style="color:#24292E">(data) </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> data</span><span style="color:#24292E">(</span><span style="color:#005CC5">this</span><span style="color:#24292E">.state.data) </span><span style="color:#D73A49">:</span><span style="color:#24292E"> data</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 调用插件里的钩子onMutate</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">runPluginHandler</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;onMutate&#x27;</span><span style="color:#24292E">, targetData)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 强制渲染新状态</span></span>
<span data-line=""><span style="color:#005CC5">    this</span><span style="color:#24292E">.</span><span style="color:#6F42C1">setState</span><span style="color:#24292E">({</span></span>
<span data-line=""><span style="color:#24292E">      data: targetData,</span></span>
<span data-line=""><span style="color:#24292E">    })</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure></div><footer class="mt-[32px]"><div class="border-divider flex justify-between border-t pt-[24px]"><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">上一页</div><div class=" text-text-2 group-hover:text-brand overflow-hidden text-ellipsis whitespace-nowrap text-[14px] font-[500] leading-[20px] transition-colors duration-300">use(Raf)Timeout与use(Raf)Interval与useCountDown</div></a></div><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">下一页</div><div class=" text-text-2 group-hover:text-brand overflow-hidden text-ellipsis whitespace-nowrap text-[14px] font-[500] leading-[20px] transition-colors duration-300">useMount与useUnMount与useMountedRefx.md</div></a></div></div></footer></div></div><aside class="w-toc full:flex sticky top-[calc(theme(spacing.nav)+48px)] hidden h-full flex-col"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#userequestimplement" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">useRequestImplement</a></div><div><a href="#fetch" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">Fetch</a></div></div></div></aside></div></div></div>
  
    <script type="module" src="/client-entry.js"></script>
    </body>
    
</html>
