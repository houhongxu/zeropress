import{fileURLToPath as dt}from"url";import ft from"path";var gt=()=>dt(import.meta.url),xt=()=>ft.dirname(gt()),c=xt();import v from"path";var C=v.join(c,"..",".."),w=v.join(C,"./src"),Y=v.join(w,"./runtime"),j=v.join(Y,"./client/client-entry.tsx"),Z=v.join(Y,"./server/server-entry.tsx"),B=v.join(C,"./.zeropress"),P="./dist",I="./public",H=v.join(C,"./index.html"),J=["zeropress.config.ts","zeropress.config.js"],h={docs:"docs",title:"ZEROPRESS",description:"SSG Framework",themeConfig:{nav:[{text:"ZEROPRESS",link:"/",position:"left"}],autoNav:!0,autoSidebar:!0},icp:"",vite:{}},vt=v.join(c,".."),ht=v.join(vt,"runtime"),K=v.join(ht,"./lazyWithPreload.js");import N from"fs-extra";import E from"path";var Pt=t=>/\.mdx?/.test(t);function q({siteConfig:t}){return{name:"vitePluginBuildImg",apply:"build",transform(e,o){let n=e;if(Pt(o)&&e.includes("_components.img")){let r=E.dirname(o),[,i]=r.split("docs"),s=/_components\.img[^}]*?\bsrc:\s*["']([^"']+)["']/g;Array.from(e.matchAll(s),a=>a[1]).forEach(async a=>{let m=decodeURI(a);if(a.startsWith("./")){let p=E.join(encodeURI(i),a);n=n.replace(a,p);let f=E.join(r,m),g=E.join(t.root,P,i,m),u=await N.exists(f),x=await N.exists(g);u&&!x&&(await N.ensureDir(E.dirname(g)),await N.copyFile(f,g))}})}return n}}}import{parse as Ct}from"acorn";import yt from"github-slugger";import{visit as Tt}from"unist-util-visit";var Q=()=>t=>{let e=[];Tt(t,"heading",i=>{if(i.depth>1&&i.depth<8){let l=i.children.map(p=>{switch(p.type){case"link":return p.children?.map(f=>f.value).join("")||"";default:return p.value}}).join(""),m=new yt().slug(l);e.push({id:m,text:l,depth:i.depth})}});let o=`export const GetToc = () => ${JSON.stringify(e,null,2)};`,r={type:"mdxjsEsm",value:"",data:{estree:Ct(o,{ecmaVersion:"latest",sourceType:"module"})}};t.children.unshift(r)};import bt from"@mdx-js/rollup";import St from"rehype-autolink-headings";import Rt from"rehype-pretty-code";import wt from"rehype-slug";import It from"remark-frontmatter";import Et from"remark-gfm";import _t from"remark-mdx-frontmatter";function X(){let t=e=>/\.mdx?/.test(e);return{enforce:"pre",async handleHotUpdate(e){t(e.file)&&(console.log("\u81EA\u5B9A\u4E49hmr\u4E8B\u4EF6:",e.file),e.server.ws.send({type:"custom",event:"mdx?-update"}))},...bt({remarkPlugins:[Et,It,_t,Q],rehypePlugins:[wt,[St,{properties:{class:"autolink-headings"},content:{type:"element",tagName:"span",properties:{style:"margin-right: 4px;"},children:[{type:"text",value:"#"}]}}],[Rt,{theme:"github-light"}]]})}}import Ot from"fs-extra";function tt({templatePath:t,entry:e}){return{name:"vitePluginServeHtml",apply:"serve",configureServer(o){return()=>{o.middlewares.use(async(n,r,i)=>{if(!n.url?.endsWith(".html")&&n.url!=="/")return i();let s=await Ot.readFile(t,"utf-8"),a=(await o.transformIndexHtml?.(n.url,s,n.originalUrl)).replace("</body>",`
              <script type="module" src="${e}"></script>
              

              </body>
              `);r.statusCode=200,r.setHeader("Content-Type","text/html"),r.end(a)})}}}}import et from"fs-extra";import jt from"mime";import rt from"path";var Ht=t=>t?/\.(jpg|jpeg|png|gif|svg|webp)$/i.test(t):!1;function ot({siteConfig:t}){return{name:"vite-plugin-fixed-image-dev",apply:"serve",configureServer(e){e.middlewares.use(async(o,n,r)=>{if(Ht(o.url)){let i=decodeURI(o.url);if(!await et.exists(rt.join(t.root,I,i))){let l=rt.join(t.root,t.userConfig.docs,i),a=jt.getType(l);a&&n.setHeader("Content-Type",a),et.createReadStream(l).pipe(n);return}}return r()})}}}function it(){let t=e=>/\.mdx?/.test(e);return{name:"vitePluginTransformFrontmatter",enforce:"post",transform(e,o){if(t(o))return e=e.replace("export const frontmatter","const frontmatter"),e+=`
 export const GetFrontMatter = () => frontmatter`,{code:e}}}}import Nt from"path";function nt({siteConfig:t,restartRuntimeDevServer:e}){let o="virtual:config",n="\0"+o;return{name:"vitePluginVirtualConfig",resolveId(r){if(r===o)return n},load(r){if(r===n)return`export default ${JSON.stringify(t.userConfig)}`},async handleHotUpdate(r){let i=t.userConfigPath?Nt.basename(t.userConfigPath):void 0;i&&r.file.includes(i)&&e&&(console.log("\u76D1\u542C\u5230\u914D\u7F6E\u6587\u4EF6\u66F4\u65B0\uFF0C\u91CD\u542F\u670D\u52A1\u4E2D:",r.file),await e())}}}import{spawn as At}from"cross-spawn";import Dt from"dayjs";import Ut from"fast-glob";import kt from"fs-extra";import st from"path";async function A(t=h.docs,e){return await Ut.glob("**/*.{jsx,tsx,md,mdx}",{ignore:["node_modules/**","client/**","server/**"],cwd:t,deep:3,...e})}var at=new Map;function mt(t){let e=at.get(t);return e||(kt.existsSync(t)?new Promise((o,n)=>{let r=At("git",["log","-1",'--pretty="%ai"',st.basename(t)],{cwd:st.dirname(t)}),i="";r.stdout.on("data",s=>i+=String(s)),r.on("close",()=>{if(i){let s=Dt(i).unix();at.set(t,s),o(s)}else o(void 0)}),r.on("error",n)}):0)}async function V(t,e,o){let n=new Array(t.length),r=[];for(let i=0;i<t.length;i++){let s=t[i],l=(async()=>{let a=await o(s);n[i]=a})();r.push(l),r.length>=e&&await Promise.race(r)}return await Promise.all(r),n}function y(t="/"){return encodeURI(t)}function D(t){return t&&t+".html"}function U(t,e){return t.reduce((o,n)=>{let r=n[e];return o[r]||(o[r]=[]),o[r].push(n),o},{})}function G(t,e){return t.reduce((o,n)=>{let r=n[e];return o[r]=n,o},{})}function k(t){let e=t?.match(/^(\d+)(\.?\s*)(.*)$/),o=e?.[1];return o?{index:parseInt(o),text:e?.[3]??""}:{index:0,text:t??""}}import Mt from"fs";import lt from"path";var $t=Mt.readFileSync(K,"utf-8");function pt({siteConfig:t,isServer:e}){let o="virtual:routes",n="\0"+o,r=t.userConfig.docs;return{name:"vitePluginVirtualRoutes",resolveId(i){if(i===o)return n},async load(i){if(i===n){let s=await A(r,{absolute:!0}),l=`import React from "react";
`,a=await Promise.all(s.map(async(m,p)=>{let g=lt.relative(r,m).replace(lt.extname(m),"").replace(/index$/,"");l+=e?`import Element${p+1} from '${m}';
`:`const Element${p+1} = lazyWithPreload(()=> import('${m}'));
`;let u=await mt(m);return`{
            file:'${m}', 
            timestamp:'${u??""}', 
            path: '/${y(D(g))}', 
            element: React.createElement(Element${p+1}), 
            preload: ${e?`()=>Element${p+1}`:`()=> Element${p+1}.preload()`}
            },
`}));return`
        ${$t.toString()}
        ${l}
        export default [${a.join("")}]
        `}}}}import Ft from"@vitejs/plugin-react";function M({siteConfig:t,restartRuntimeDevServer:e,isServer:o}){return[X(),Ft({include:/\.(md|mdx|js|jsx|ts|tsx)$/}),tt({templatePath:H,entry:j}),nt({siteConfig:t,restartRuntimeDevServer:e}),pt({siteConfig:t,isServer:o}),it(),q({siteConfig:t}),ot({siteConfig:t})]}import{addDynamicIconSelectors as Lt}from"@iconify/tailwind";import zt from"path";var $={content:[zt.join(c,"..","..","./src/default-theme/**/*.{tsx,ts,jsx,js}")],darkMode:"selector",theme:{extend:{screens:{pc:"768px",full:"1060px"},colors:{divider:"var(--ep-color-divider)",brand:"var(--ep-color-brand)",bg:{default:"var(--ep-color-bg-default)",switch:"var(--ep-color-bg-switch)",inverse:"var(--ep-color-bg-inverse)",sidebar:"var(--ep-color-bg-sidebar)"},text:{1:"var(--ep-color-text-1)",2:"var(--ep-color-text-2)",3:"var(--ep-color-text-3)",4:"var(--ep-color-text-4)"},gray:{1:"var(--ep-color-gray-1)"}},boxShadow:{1:"0 1px 2px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06)",2:"0 3px 12px rgba(0, 0, 0, 0.07), 0 1px 4px rgba(0, 0, 0, 0.07)",3:"0 12px 32px rgba(0, 0, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.08)",4:"0 14px 44px rgba(0, 0, 0, 0.12), 0 3px 9px rgba(0, 0, 0, 0.12)",5:"0 18px 56px rgba(0, 0, 0, 0.16), 0 4px 12px rgba(0, 0, 0, 0.16)"},spacing:{nav:"56px",sidebar:"250px",toc:"200px"}}},plugins:[Lt()]};import Bt from"autoprefixer";import T from"fs-extra";import b from"path";import Vt from"tailwindcss";import{build as Gt}from"vite";async function ct({siteConfig:t}){console.log("\u5220\u9664\u65E7\u4EA7\u7269\uFF1A",P),await T.remove(P),console.log("\u6784\u5EFAjs\u6587\u4EF6...");let[e,o]=await V([{siteConfig:t},{siteConfig:t,isServer:!0}],10,Wt);console.log("\u6784\u5EFAhtml\u6587\u4EF6..."),await Yt({siteConfig:t,clientBundle:e,serverBundle:o})}function Wt({isServer:t=!1,siteConfig:e}){return Gt({mode:"production",base:"./",root:C,plugins:M({siteConfig:e,isServer:t}),build:{ssr:t,outDir:t?B:b.join(e.root,P),rollupOptions:{input:t?Z:j,output:{entryFileNames:t?"server-entry.cjs":"client-entry.[hash].js",format:t?"cjs":"es"}}},css:{postcss:{plugins:[Vt($),Bt({})]}},resolve:{alias:{"@":w}}})}async function Yt({clientBundle:t,serverBundle:e,siteConfig:o}){let n=t.output.find(u=>u.type==="chunk"&&u.isEntry),r=e.output.find(u=>u.type==="chunk"&&u.isEntry);if(!n||!r)throw new Error("\u6784\u5EFA\u4EA7\u7269\u4E3A\u7A7A");let i=t.output.filter(u=>u.type==="asset"&&u.fileName.endsWith(".css"));await T.exists(I)&&await T.copy(I,b.join(P));let s=b.join(B,r?.fileName),l=`/${n?.fileName}`,a={},{render:m,routes:p}=await import(s),{helmet:f}=a,g=await T.readFile(H,"utf-8");await V(p,10,async u=>{let x=u.path==="/"?"/index.html":u.path,_=`${P}${x}`,z={},S=await m(u.path||"/",z),O=g.replace("<title>ZEROPRESS</title>",f?.title?.toString()||"").replace("<!--app-html-->",S).replace("</body>",`
    <script type="module" src="${l}"></script>
    </body>
    `).replace("</head>",i.map(R=>`<link rel="stylesheet" href="/${R.fileName}">`).join(`
`));T.ensureDir(b.join(o.root,b.dirname(_))).catch(R=>console.log("client\u6587\u4EF6\u5939\u4E0D\u5B58\u5728\uFF1A",R)).then(()=>T.writeFile(b.join(o.root,_),O)).catch(R=>console.log("html\u5199\u5165\u5931\u8D25",R))})}import Zt from"fs-extra";import F from"path";import{loadConfigFromFile as Jt}from"vite";async function W({root:t=process.cwd(),command:e,mode:o}){let{userConfigPath:n,userConfig:r={}}=await qt({root:t,mode:o,command:e}),i=r.docs??h.docs,s=await Kt({docs:i}),l=r.themeConfig?.nav?.findIndex(x=>x.position==="left")??0,a=r.themeConfig?.autoNav===!1?r.themeConfig.nav??[]:[...(r.themeConfig?.nav??[]).slice(0,l),...s.nav,...(r.themeConfig?.nav??[]).slice(l)],m=r.themeConfig?.autoSidebar===!1?r.themeConfig.sidebar??{}:s.sidebar,p=a.map(x=>({...x,link:y(x.link)})),f=Object.entries(m).reduce((x,[_,z])=>(x[y(_)]=z.map(S=>({...S,link:y(S.link),items:S.items?.map(O=>({...O,link:y(O.link)}))})),x),{}),g={docs:i,title:r.title??h.title,description:r.description??h.description,icp:r.icp??h.icp,themeConfig:r.themeConfig?{...r.themeConfig,nav:p,sidebar:f,autoNav:!0,autoSidebar:!0}:{...h.themeConfig,nav:p,sidebar:f,autoNav:!0,autoSidebar:!0},vite:r.vite??h.vite};return{root:t,userConfigPath:n,userConfig:g}}async function Kt({docs:t}){let o=(await A(t)).filter(i=>!i.includes("index.md")).map(i=>{let s=i.split("/")[0],l=i.split("/")[1],a=i.split("/")[2],m=k(s),p=k(l),f=k(a);return{path:`/${D(i.replace(F.extname(i),""))}`,nav:s,dir:l,file:a,navIndex:m.index,navText:m.text,navPath:`/${s}`,siderbarDirIndex:p.index,siderbarDirText:p.text.replace(F.extname(p.text),""),fileIndex:f.index,fileText:f.text.replace(F.extname(f.text),"")}}),n=Object.entries(U(o,"navText")).map(([i,s])=>({text:i,index:G(s,"navText")[i].navIndex,link:s.sort((l,a)=>l.siderbarDirIndex-a.siderbarDirIndex+l.fileIndex-a.fileIndex)[0].path})).sort((i,s)=>i.index-s.index),r=Object.entries(U(o,"navPath")).reduce((i,[s,l])=>{let a=Object.entries(U(l,"siderbarDirText")).reduce((m,[p,f])=>(m[p]=f.sort((g,u)=>g.fileIndex-u.fileIndex).map(g=>({text:g.fileText,link:g.path})).filter(g=>g.text),m),{});return i[s]=Object.values(G(l.sort((m,p)=>m.siderbarDirIndex-p.siderbarDirIndex).map(m=>({text:m.siderbarDirText,items:a[m.siderbarDirText],link:m.path})),"text")),i},{});return{nav:n,sidebar:r}}async function qt({root:t=process.cwd(),command:e,mode:o}){let n=Qt({root:t}),r=await Jt({command:e,mode:o},n,t);return{userConfigPath:n,userConfig:r?.config}}function Qt({root:t=process.cwd()}){return J.map(o=>F.join(t,o)).find(o=>Zt.existsSync(o))}import Xt from"autoprefixer";import te from"tailwindcss";import{createServer as ee}from"vite";function ut({siteConfig:t,restartRuntimeDevServer:e}){return ee({root:t.root,server:{host:!0},plugins:M({restartRuntimeDevServer:e,siteConfig:t}),css:{postcss:{plugins:[te($),Xt({})]}},resolve:{alias:{"@":w}},optimizeDeps:{include:["zeropress > react-fast-compare","zeropress > classnames","zeropress > invariant","zeropress > shallowequal","zeropress > dayjs","zeropress > react-dom/client"],exclude:["@/runtime","@/node","@/default-theme","@/shared"]}})}import{program as re}from"commander";import oe from"fs-extra";import ie from"path";var L=re,{version:ne}=oe.readJSONSync(ie.join(C,"./package.json"));L.name("zeropress").version(ne);L.command("dev",{isDefault:!0}).description("dev server").option("-p,--port <value>","dev server port").action(async({port:t})=>{let e=async()=>{let o=await W({mode:"development",command:"serve"}),n=await ut({siteConfig:o,restartRuntimeDevServer:async()=>{await n.close(),await e()}});await n.listen(t),n.printUrls();let r=!1;n.watcher.on("all",async(i,s)=>{!r&&i!=="change"&&(console.log("\u76D1\u542C\u5230\u6587\u4EF6\u589E\u5220\u6539\uFF0C\u91CD\u542F\u670D\u52A1\u4E2D:",s),r=!0,await n.close(),await e(),r=!1)})};await e()});L.command("build").description("build").action(async()=>{try{let t=await W({mode:"production",command:"build"});await ct({siteConfig:t}),console.log("\u6784\u5EFA\u6210\u529F")}catch(t){console.log(t)}});L.parse();export{L as cli};
//# sourceMappingURL=cli.js.map